import { createAsyncThunk, createSlice, PayloadAction } from '@reduxjs/toolkit'

import type { AppState } from '../../app/store'
import {connectWallet, getConfiguration} from './walletAPI'

type ConnectStatus = 'NOT_INSTALLED' | 'INSTALLED' | 'CONNECTED';

export interface WalletState {
    account?: string
    status: ConnectStatus
    networkAddress?: string
    networkName?: string
    chainId?: string
    isOwner: boolean
    userName?: string
}

const initialState: WalletState = {
    status: 'NOT_INSTALLED',
    isOwner: false,
}

// The function below is called a thunk and allows us to perform async logic. It
// can be dispatched like a regular action: `dispatch(incrementAsync(10))`. This
// will call the thunk with the `dispatch` function as the first argument. Async
// code can then be executed and other actions can be dispatched. Thunks are
// typically used to make async requests.
export const connectToWallet = createAsyncThunk(
    'wallet/connect',
    async () => {
        try {
            return await connectWallet()
        } catch (e) {
            console.error(e)
            throw e
        }
    }
)

export const initConfiguration = createAsyncThunk('wallet/init', async () => {
    return await getConfiguration()
})

export const walletSlice = createSlice({
    name: 'wallet',
    initialState,
    // The `reducers` field lets us define reducers and generate associated actions
    reducers: {
        setStatus: (state, action: PayloadAction<ConnectStatus>) => {
            state.status = action.payload
        },
        setAccount: (state, action: PayloadAction<string>) => {
            state.account = action.payload
        },
        setChainId: (state, action: PayloadAction<string>) => {
            state.chainId = action.payload
        },
        resetConnectState: (state, action: PayloadAction<any>) => {
            state.account = undefined
        },
        setUserName: (state, action: PayloadAction<string>) => {
            if (state.userName == action.payload) {
                return;
            }
            state.userName = action.payload;
        }
    },
    // The `extraReducers` field lets the slice handle actions defined elsewhere,
    // including actions generated by createAsyncThunk or in other slices.
    extraReducers: (builder) => {
    },
})
export const {setAccount, setStatus, setChainId, setUserName} = walletSlice.actions


// The function below is called a selector and allows us to select a value from
// the state. Selectors can also be defined inline where they're used instead of
// in the slice file. For example: `useSelector((state: RootState) => state.counter.value)`
export const selectWallet = (state: AppState) => state.wallet
export const selectUserName = (state: AppState) => state.wallet.userName
export const selectIsOwner = (state: AppState) => (state.wallet.account === process.env.NEXT_PUBLIC_OWNER_ADDRESS)



export default walletSlice.reducer
