import { createAsyncThunk, createSlice, PayloadAction } from '@reduxjs/toolkit'

import type { AppState } from '../../app/store'
import {connectWallet, getConfiguration} from './walletAPI'

type ConnectStatus = 'NOT_INSTALLED' | 'INSTALLED' | 'CONNECTED';
export interface WalletNetworkConfiguration {
    networkAddress: string
    networkName: string
    chainId: string
    networkId: number
    tokenAddress: string
    tokenImage?: string
    mainContractAddress: string
    apiContractAddress: string
    ownerAddress: string
}

export interface WalletState {
    account?: string
    status: ConnectStatus
    configuration: WalletNetworkConfiguration
    networkAddress?: string
    networkName?: string
    chainId?: string
    isOwner: boolean
}

const initialState: WalletState = {
    status: 'NOT_INSTALLED',
    isOwner: false,
    configuration: {
        networkAddress: 'http://10.211.55.5:7505',
        networkName: "Wish Local Network",
        networkId: 5777,
        chainId: '0x1691',

        "apiContractAddress":"0x90C2C05D0de75BBB5e10ee456b220Dd4A44680c9",
        "mainContractAddress":"0x5E0563a6A0E89429A131BE3869cBc1a646652346",
        "tokenAddress":"0x54c26fc79983f1Ad9897A53f63C0adea96B9Cb07",
        ownerAddress: "0x511eb3624c750a11465799fc143cfc26232560f9"
    }
}

// The function below is called a thunk and allows us to perform async logic. It
// can be dispatched like a regular action: `dispatch(incrementAsync(10))`. This
// will call the thunk with the `dispatch` function as the first argument. Async
// code can then be executed and other actions can be dispatched. Thunks are
// typically used to make async requests.
export const connectToWallet = createAsyncThunk(
    'wallet/connect',
    async () => {
        try {
            return await connectWallet()
        } catch (e) {
            console.error(e)
            throw e
        }
    }
)

export const initConfiguration = createAsyncThunk('wallet/init', async () => {
    return await getConfiguration()
})

export const walletSlice = createSlice({
    name: 'wallet',
    initialState,
    // The `reducers` field lets us define reducers and generate associated actions
    reducers: {
        setStatus: (state, action: PayloadAction<ConnectStatus>) => {
            state.status = action.payload
        },
        setAccount: (state, action: PayloadAction<string>) => {
            state.account = action.payload
        },
        setChainId: (state, action: PayloadAction<string>) => {
            state.chainId = action.payload
        },
        resetConnectState: (state, action: PayloadAction<any>) => {
            state.account = undefined
        }
    },
    // The `extraReducers` field lets the slice handle actions defined elsewhere,
    // including actions generated by createAsyncThunk or in other slices.
    extraReducers: (builder) => {
    },
})
export const {setAccount, setStatus, setChainId} = walletSlice.actions


// The function below is called a selector and allows us to select a value from
// the state. Selectors can also be defined inline where they're used instead of
// in the slice file. For example: `useSelector((state: RootState) => state.counter.value)`
export const selectWallet = (state: AppState) => state.wallet
export const selectIsOwner = (state: AppState) => (state.wallet.account === state.wallet.configuration.ownerAddress)



export default walletSlice.reducer
